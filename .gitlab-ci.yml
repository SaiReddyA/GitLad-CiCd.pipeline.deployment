stages:
  - build
  - package
  - release
  - deploy

# -------------------------------------------
# 1️⃣ BUILD JOB — prepare files
# -------------------------------------------
build-static-site:
  stage: build
  image: node:18
  variables:
    VERSION: "1.0.0"
  script:
    - echo "Preparing static site..."
    - mkdir build_output
    - cp -r * build_output/
    - echo "Build completed."
  artifacts:
    paths:
      - build_output/
    expire_in: 1 day
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'



package-artifact:
  stage: package
  script:
    - echo "Packaging build..."
    - zip -r site-$CI_PIPELINE_IID.zip build_output/
  needs: ["build-static-site"]
  artifacts:
    paths:
      - site-$CI_PIPELINE_IID.zip
    expire_in: 7 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

create-release-tag:
  stage: release
  script:
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
    - export VERSION="v1.0.$CI_PIPELINE_IID"
    - echo "Creating release tag: $VERSION"
    - git tag $VERSION
    - git push origin $VERSION
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy-static-site:
  stage: deploy
  image: node:18
  variables:
    CI_DEBUG_TRACE: "true"     # enable debugging
  script:
    - npm install -g netlify-cli
    - echo "Deploying version v1.0.$CI_PIPELINE_IID"
    - netlify deploy --prod --dir=build_output/ --site=$NETLIFY_SITE_ID --auth=$NETLIFY_AUTH_TOKEN
  needs: ["build-static-site"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

##########################V2###########################################
# stages:
#   - deploy

# deploy-static-site:
#   stage: deploy
#   image: node:18
#   variables:
#     CI_DEBUG_TRACE: "true"
#   script:
#     - npm install -g netlify-cli
#     - netlify deploy --prod --dir=./ --site=$NETLIFY_SITE_ID --auth=$NETLIFY_AUTH_TOKEN
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "main"'

#v1##########################################################
# stages:        
#   - build
#   - test
#   - deploy

# #  BUILD JOB
# build-job:      
#   stage: build
#   script:
#     - echo "Compiling the code..."
#     - mkdir build_output
#     - echo "Build files inside this folder" > build_output/result.txt
#     - echo "Compile complete."

#   #  Cache example (dependencies)
#   cache:
#     key: my-cache           # unique cache name
#     paths:
#       - build_output/       # normally node_modules, packages, etc.

#   #  Artifacts example (output for next jobs)
#   artifacts:
#     paths:
#       - build_output/       # this will be available for TEST + DEPLOY jobs
#     expire_in: 1 hour        # optional (default keeps forever)
#    rules:
#     - if: '$CI_COMMIT_BRANCH == "main"'
#       when: always

# #  UNIT TEST JOB
# unit-test-job:   
#   stage: test
#   needs: ["build-job"]      # to download artifacts
#   script:
#     - echo "Running unit tests... This will take about 60 seconds."
#     - sleep 60
#     - echo "Code coverage is 90%"
#     - ls -l build_output/   # showing artifact is available
#   rules:
#     - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
#       when: always
# #  LINT TEST JOB
# lint-test-job:   
#   stage: test
#   needs: ["build-job"]      # get build-job's artifacts
#   script:
#     - echo "Linting code... This will take about 10 seconds."
#     - sleep 10
#     - echo "No lint issues found."
#     - ls -l build_output/   # artifact visible here also

#  rules:
#     - if: '$CI_COMMIT_TAG'
#       when: never     # skip job on tags
#     - when: always     # run for all other cases

# #  DEPLOY JOB
# deploy-job:     
#   stage: deploy
#   environment: production
#   needs: ["build-job"]      # get build output from artifacts
#   script:
#     - echo "Deploying application..."
#     - ls -l build_output/   # verify artifacts passed till deploy
#     - echo "Application successfully deployed."
# rules:
#     - when: manual   # run by clicking “Play” button



